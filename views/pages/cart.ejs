<!DOCTYPE html>
<html>
<%- include ("../partials/head.ejs") %>
	<script>
		async function enleverProduits(i) {
			var listeProduits = "<%= compterProduits() %>";
			id = listeProduits.split(",")[i].split(";")[0];
			await fetch("/api/cart/enlever", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					idClient: "<%= idClient %>",
					produitId: id
				}),
			});
		}
		async function changerQuantiteDeProd(id,i){
			var listeProduits = "<%= compterProduits() %>";
			quant = document.getElementById(`quant${i}`).value;
			await fetch("/api/cart/modifierQuantiter", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					idClient: "<%= idClient %>",
					produitId: id,
					Quant : quant
				}),
			});
		}

		

	</script>

	<body>
		<!-- navbar-->
		<%- include ("../partials/navbar.ejs") %>
			<% var total=0 %>
				<div id="all">
					<div id="content">
						<div class="container">
							<div class="row">
								<div id="basket" class="col-lg-9">
									<div class="box">
										<div class="table-responsive">
											<table class="table">
												<thead>
													<tr>
														<th colspan="2">Product</th>
														<th>Quantity</th>
														<th>Unit price</th>
														<th colspan="2">Subtotal</th>
													</tr>
												</thead>
												<tbody>
													<div id="BoiteProduits">
														<% ListeProduits=compterProduits(); for (let i=0; i <
															ListeProduits.length; i++) {
															id=ListeProduits[i].split(";")[0];
															nb=ListeProduits[i].split(";")[1];
															produit=produits.find(produit=> produit._id == id);
															nom = produit.nom;
															prix = produit.prix;
															subtot = prix * nb;
															%>
															<tr>
																<td>
																	<a href="/product/<%=id%>"><img
																			src="/assets/img/<%=nom%>.jpg" /></a>
																</td>
																<td><a href="/product/<%=id%>">
																		<%=nom%>
																	</a></td>
																<td>
																	<input type="number" value="<%=nb%>"
																		 id="quant<%=i%>" onchange='changerQuantiteDeProd("<%=id%>","<%=i%>")'
																		min="1" />
																</td>
																<td id="price">
																	<%=prix%>$
																</td>
																<td>
																	<div id="subT">
																		<%=subtot.toFixed(2)%>$
																	</div>

																</td>
																<td>
																	<button class="btn-primary"
																		onclick="enleverProduits(<%=i%>), window.location.reload()"><i
																			class="fa fa-trash-o"></i></button>
																</td>
															</tr>
													</div>
													<%total+= subtot%>
													<% } %>
										</div>

										</tbody>
										<tfoot>
											<tr>
												<th colspan="5">Total</th>
												<th colspan="2" id="total">
													<%= total.toFixed(2) %>$
												</th>
											</tr>
											<tr>
												<th colspan="5"> <button type="submit" class="btn btn-primary">
													Proceed to checkout <i class="fa fa-chevron-right"></i>
												</button></th>
											</tr>
										</tfoot>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				</div>
				</div>
				<%- include ("../partials/footer.ejs") %>

					<!-- JavaScript files-->
					<%- include ("../partials/javascript.ejs") %>
	</body>

	<%function compterProduits() { nbProduits=0; idsProduits=[]; for (let i=0; i < produits.length; i++) {
		produitDuplique=false; for (let j=0; j < idsProduits.length; j++) { if
		(produits[i]._id==idsProduits[j].split(";")[0]) { produitDuplique=true; idsProduits[j]=produits[i]._id + ";" +
		(parseInt(idsProduits[j].split(";")[1]) + 1); break; } } if (!produitDuplique) { nbProduits++;
		idsProduits.push(produits[i]._id + ";1" ); } } return idsProduits; } function enleverProduit(id) {
		console.log("id="+id);
		}
		%>
		
</html>